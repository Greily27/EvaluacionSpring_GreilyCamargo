<!DOCTYPE html>
<html lang="es" xmlns:th="http://thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Panel de Administrador - BeautyCare</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" th:href="@{/assets/css/admin.css}" />

</head>

<body>
	<!-- Sidebar -->
	<div class="sidebar">
		<div class="logo">
			<i class="fas fa-spa"></i>
			<span>BeautyCare</span>
		</div>
		<ul class="menu">
			<li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
			<li><a href="#"><i class="fas fa-concierge-bell"></i> Servicios</a></li>
			<li><a href="#"><i class="fas fa-calendar-check"></i> Citas</a></li>
			<li><a href="#"><i class="fas fa-users"></i> Usuarios</a></li>
			<li><a href="#"><i class="fas fa-chart-bar"></i> Reportes</a></li>
			<li><a href="#"><i class="fas fa-cog"></i> Configuración</a></li>
		</ul>
	</div>

	<!-- Main Content -->
	<div class="main-content">
		<!-- Topbar -->
		<div class="topbar">
			<h2>Panel de Administración</h2>
			<div class="user-info">
				<div class="user-avatar">A</div>
				<div>
					<div>Administrador</div>
					<small>admin@beautycare.com</small>
				</div>
			</div>
		</div>

		<!-- Content -->
		<div class="content">
			<div class="page-title">
				<h1>Gestión de Servicios y Citas</h1>
				<div>
					<button class="btn btn-primary" id="btnNuevoServicio">
						<i class="fas fa-plus"></i> Nuevo Servicio
					</button>
					<button class="btn btn-primary" id="btnNuevaCita">
						<i class="fas fa-plus"></i> Nueva Cita
					</button>
				</div>
			</div>

			<!-- Stats -->
			<div class="stats">
				<div class="stat-card">
					<div class="stat-icon stat-1">
						<i class="fas fa-concierge-bell"></i>
					</div>
					<div class="stat-info">
						<h3 id="totalServicios">0</h3>
						<p>Total Servicios</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon stat-2">
						<i class="fas fa-calendar-check"></i>
					</div>
					<div class="stat-info">
						<h3 id="totalCitas">0</h3>
						<p>Citas del Mes</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon stat-3">
						<i class="fas fa-users"></i>
					</div>
					<div class="stat-info">
						<h3 id="totalUsuarios">0</h3>
						<p>Usuarios Activos</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon stat-4">
						<i class="fas fa-dollar-sign"></i>
					</div>
					<div class="stat-info">
						<h3 id="ingresosMes">$0</h3>
						<p>Ingresos del Mes</p>
					</div>
				</div>
			</div>

			<!-- Tabs -->
			<div class="tabs">
				<div class="tab active" data-tab="servicios">Servicios</div>
				<div class="tab" data-tab="citas">Citas</div>
				<div class="tab" data-tab="usuarios">Usuarios</div>
			</div>

			<!-- Servicios Tab -->
			<div class="tab-content active" id="servicios">
				<table id="tablaServicios">
					<thead>
						<tr>
							<th>ID</th>
							<th>Nombre</th>
							<th>Descripción</th>
							<th>Precio</th>
							<th>Duración</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody id="cuerpo-tabla-servicios">
						<!-- Los servicios se cargarán aquí dinámicamente -->
					</tbody>
				</table>

				<div id="estado-vacio-servicios" class="empty-state"
					style="display: none; text-align: center; padding: 40px 20px; color: var(--texto-claro);">
					<i class="fas fa-clipboard-list"
						style="font-size: 3rem; margin-bottom: 15px; color: var(--lila);"></i>
					<h3>No hay servicios registrados</h3>
					<p>Agrega tu primer servicio para comenzar</p>
					<button class="btn btn-primary" id="btnAgregarPrimerServicio">
						<i class="fas fa-plus"></i> Agregar Servicio
					</button>
				</div>
			</div>

			<!-- Citas Tab -->
			<div class="tab-content" id="citas">
				<table id="tablaCitas">
					<thead>
						<tr>
							<th>ID</th>
							<th>ID Usuario</th>
							<th>Servicio</th>
							<th>Fecha</th>
							<th>Hora</th>
							<th>Estado</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody id="cuerpo-tabla-citas">
						<!-- Las citas se cargarán aquí dinámicamente -->
					</tbody>
				</table>

				<div id="estado-vacio-citas" class="empty-state"
					style="display: none; text-align: center; padding: 40px 20px; color: var(--texto-claro);">
					<i class="fas fa-calendar-times"
						style="font-size: 3rem; margin-bottom: 15px; color: var(--lila);"></i>
					<h3>No hay citas programadas</h3>
					<p>Agrega tu primera cita para comenzar</p>
					<button class="btn btn-primary" id="btnAgregarPrimeraCita">
						<i class="fas fa-plus"></i> Agregar Cita
					</button>
				</div>
			</div>

			<!-- Usuarios Tab -->
			<div class="tab-content" id="usuarios">
				<table id="tablaUsuarios">
					<thead>
						<tr>
							<th>ID Usuario</th>
							<th>Nombre</th>
							<th>Email</th>
							<th>Teléfono</th>
							<th>Fecha Registro</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody id="cuerpo-tabla-usuarios">
						<!-- Los usuarios se cargarán aquí dinámicamente -->
					</tbody>
				</table>

				<div id="estado-vacio-usuarios" class="empty-state"
					style="display: none; text-align: center; padding: 40px 20px; color: var(--texto-claro);">
					<i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; color: var(--lila);"></i>
					<h3>No hay usuarios registrados</h3>
					<p>Los usuarios aparecerán aquí cuando se registren</p>
				</div>
			</div>

			<!-- Formulario Servicio -->
			<div class="form-container" id="formServicio">
				<div class="form-header">
					<h2 id="tituloFormServicio">Agregar Nuevo Servicio</h2>
					<button class="close-btn" id="cerrarFormServicio">
						<i class="fas fa-times"></i>
					</button>
				</div>

				<div class="form-grid">
					<div class="form-group">
						<label for="nombreServicio">Nombre del servicio *</label>
						<input type="text" id="nombreServicio" placeholder="Ej: Manicure Deluxe" required>
					</div>

					<div class="form-group">
						<label for="precioServicio">Precio *</label>
						<input type="number" id="precioServicio" placeholder="0.00" min="0" step="0.01" required>
					</div>

					<div class="form-group">
						<label for="duracionServicio">Duración (minutos) *</label>
						<input type="number" id="duracionServicio" placeholder="60" min="1" required>
					</div>
				</div>

				<div class="form-group">
					<label for="descripcionServicio">Descripción</label>
					<textarea id="descripcionServicio" placeholder="Describe el servicio..."></textarea>
				</div>

				<div class="form-buttons">
					<button class="btn btn-secondary" id="cancelarServicio">
						<i class="fas fa-times"></i> Cancelar
					</button>
					<button class="btn btn-primary" id="guardarServicio">
						<i class="fas fa-save"></i> Guardar Servicio
					</button>
				</div>
			</div>

			<!-- Formulario Cita -->
			<div class="form-container" id="formCita">
				<div class="form-header">
					<h2 id="tituloFormCita">Agregar Nueva Cita</h2>
					<button class="close-btn" id="cerrarFormCita">
						<i class="fas fa-times"></i>
					</button>
				</div>

				<div class="form-grid">
					<div class="form-group">
						<label for="idUsuarioCita">ID Usuario *</label>
						<select id="idUsuarioCita" required>
							<option value="">Seleccionar usuario</option>
							<!-- Los usuarios se cargarán dinámicamente -->
						</select>
					</div>

					<div class="form-group">
						<label for="servicioCita">Servicio *</label>
						<select id="servicioCita" required>
							<option value="">Seleccionar servicio</option>
							<!-- Los servicios se cargarán dinámicamente -->
						</select>
					</div>

					<div class="form-group">
						<label for="fechaCita">Fecha *</label>
						<input type="date" id="fechaCita" required>
					</div>

					<div class="form-group">
						<label for="horaCita">Hora *</label>
						<input type="time" id="horaCita" required>
					</div>

					<div class="form-group">
						<label for="estadoCita">Estado *</label>
						<select id="estadoCita" required>
							<option value="pendiente">Pendiente</option>
							<option value="confirmada">Confirmada</option>
							<option value="cancelada">Cancelada</option>
							<option value="completada">Completada</option>
						</select>
					</div>
				</div>

				<div class="form-group">
					<label for="notasCita">Notas</label>
					<textarea id="notasCita" placeholder="Notas adicionales..."></textarea>
				</div>

				<div class="form-buttons">
					<button class="btn btn-secondary" id="cancelarCita">
						<i class="fas fa-times"></i> Cancelar
					</button>
					<button class="btn btn-primary" id="guardarCita">
						<i class="fas fa-save"></i> Guardar Cita
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Toast -->
	<div class="toast" id="toast">
		<i class="fas fa-check-circle"></i>
		<span id="toast-mensaje">Servicio guardado correctamente</span>
	</div>

	<script>
			const API_SERVICIOS = "http://localhost:56446/api/servicios";
			let servicios = [];
			let usuarios = [];
			let citas = [];

			let servicioEditando = null;
			let citaEditando = null;

			// ==============================
			// INICIALIZACIÓN
			// ==============================
			document.addEventListener('DOMContentLoaded', async function () {
				await cargarServicios(); // <-- carga desde backend
				actualizarEstadisticas();
				actualizarTablaServicios();
				actualizarTablaCitas();
				actualizarTablaUsuarios();
				cargarSelectUsuarios();
				cargarSelectServicios();

				// Tabs
				document.querySelectorAll('.tab').forEach(tab => {
					tab.addEventListener('click', function () {
						document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
						document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
						this.classList.add('active');
						document.getElementById(this.dataset.tab).classList.add('active');
					});
				});

				// Formularios de servicios
				document.getElementById('btnNuevoServicio').addEventListener('click', mostrarFormServicio);
				document.getElementById('btnAgregarPrimerServicio').addEventListener('click', mostrarFormServicio);
				document.getElementById('cerrarFormServicio').addEventListener('click', ocultarFormServicio);
				document.getElementById('cancelarServicio').addEventListener('click', ocultarFormServicio);
				document.getElementById('guardarServicio').addEventListener('click', guardarServicio);

				// Formularios de citas
				document.getElementById('btnNuevaCita').addEventListener('click', mostrarFormCita);
				document.getElementById('btnAgregarPrimeraCita').addEventListener('click', mostrarFormCita);
				document.getElementById('cerrarFormCita').addEventListener('click', ocultarFormCita);
				document.getElementById('cancelarCita').addEventListener('click', ocultarFormCita);
				document.getElementById('guardarCita').addEventListener('click', guardarCita);
			});

			// ==============================
			// SERVICIOS (conectado al backend)
			// ==============================

			async function cargarServicios() {
				try {
					const res = await fetch(API_SERVICIOS);
					if (!res.ok) throw new Error("Error al cargar servicios");
					servicios = await res.json();
					actualizarTablaServicios();
					cargarSelectServicios();
					actualizarEstadisticas();
				} catch (err) {
					console.error(err);
					mostrarToast("Error al obtener servicios", "error");
				}
			}

			async function guardarServicio() {
				const nombre = document.getElementById('nombreServicio').value.trim();
				const descripcion = document.getElementById('descripcionServicio').value.trim();
				const precio = parseFloat(document.getElementById('precioServicio').value);
				const duracion = parseInt(document.getElementById('duracionServicio').value);

				if (!nombre || isNaN(precio) || isNaN(duracion)) {
					mostrarToast('Por favor, completa todos los campos obligatorios', 'error');
					return;
				}

				const data = { nombre, descripcion, precio, duracion };
				try {
					let res;
					if (servicioEditando) {
						// Actualizar servicio existente
						res = await fetch(`${API_SERVICIOS}/${servicioEditando.id}`, {
							method: "PUT",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(data)
						});
					} else {
						// Crear nuevo servicio
						res = await fetch(API_SERVICIOS, {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(data)
						});
					}
					if (!res.ok) throw new Error("Error al guardar servicio");
					mostrarToast(servicioEditando ? "Servicio actualizado" : "Servicio agregado");
					ocultarFormServicio();
					await cargarServicios();
				} catch (error) {
					console.error(error);
					mostrarToast("Error al guardar servicio", "error");
				}
			}

			function editarServicio(id) {
				servicioEditando = servicios.find(s => s.id === id);
				if (servicioEditando) {
					document.getElementById('nombreServicio').value = servicioEditando.nombre;
					document.getElementById('descripcionServicio').value = servicioEditando.descripcion;
					document.getElementById('precioServicio').value = servicioEditando.precio;
					document.getElementById('duracionServicio').value = servicioEditando.duracion;
					document.getElementById('tituloFormServicio').textContent = 'Editar Servicio';
					document.getElementById('formServicio').style.display = 'block';
				}
			}

			async function eliminarServicio(id) {
				if (!confirm("¿Estás seguro de que deseas eliminar este servicio?")) return;
				try {
					const res = await fetch(`${API_SERVICIOS}/${id}`, { method: "DELETE" });
					if (!res.ok) throw new Error("Error al eliminar servicio");
					mostrarToast("Servicio eliminado correctamente");
					await cargarServicios();
				} catch (error) {
					console.error(error);
					mostrarToast("Error al eliminar servicio", "error");
				}
			}

			function mostrarFormServicio() {
				servicioEditando = null;
				document.getElementById('tituloFormServicio').textContent = 'Agregar Nuevo Servicio';
				document.getElementById('formServicio').style.display = 'block';
			}

			function ocultarFormServicio() {
				document.getElementById('formServicio').style.display = 'none';
				limpiarFormularioServicio();
			}

			function limpiarFormularioServicio() {
				document.getElementById('nombreServicio').value = '';
				document.getElementById('descripcionServicio').value = '';
				document.getElementById('precioServicio').value = '';
				document.getElementById('duracionServicio').value = '';
				servicioEditando = null;
			}

			function actualizarTablaServicios() {
				const cuerpoTabla = document.getElementById('cuerpo-tabla-servicios');
				const estadoVacio = document.getElementById('estado-vacio-servicios');

				if (servicios.length === 0) {
					cuerpoTabla.innerHTML = '';
					estadoVacio.style.display = 'block';
					return;
				}

				estadoVacio.style.display = 'none';
				cuerpoTabla.innerHTML = servicios.map(s => `
					<tr>
						<td>${s.id}</td>
						<td>${s.nombre}</td>
						<td>${s.descripcion || ''}</td>
						<td>${s.precio.toLocaleString('es-CO', { style: 'currency', currency: 'COP' })}</td>
						<td>${s.duracion} min</td>
						<td class="acciones">
							<button class="btn btn-editar" onclick="editarServicio(${s.id})"><i class="fas fa-edit"></i> Editar</button>
							<button class="btn btn-eliminar" onclick="eliminarServicio(${s.id})"><i class="fas fa-trash"></i> Eliminar</button>
						</td>
					</tr>
				`).join('');
			}

			// ==============================
			// CITAS Y USUARIOS (local)
			// ==============================
			function mostrarFormCita() {
				citaEditando = null;
				document.getElementById('tituloFormCita').textContent = 'Agregar Nueva Cita';
				document.getElementById('formCita').style.display = 'block';
			}
			function ocultarFormCita() {
				document.getElementById('formCita').style.display = 'none';
				limpiarFormularioCita();
			}
			function limpiarFormularioCita() {
				document.getElementById('idUsuarioCita').value = '';
				document.getElementById('servicioCita').value = '';
				document.getElementById('fechaCita').value = '';
				document.getElementById('horaCita').value = '';
				document.getElementById('estadoCita').value = 'pendiente';
				document.getElementById('notasCita').value = '';
				citaEditando = null;
			}
			function guardarCita() {
				mostrarToast('Funcionalidad de citas conectable próximamente');
			}

			function actualizarTablaCitas() { /* igual que antes */ }
			function actualizarTablaUsuarios() { /* igual que antes */ }
			function cargarSelectUsuarios() { /* igual que antes */ }
			function cargarSelectServicios() {
				const select = document.getElementById('servicioCita');
				select.innerHTML = '<option value="">Seleccionar servicio</option>';
				servicios.forEach(s => {
					const option = document.createElement('option');
					option.value = s.id;
					option.textContent = s.nombre;
					select.appendChild(option);
				});
			}

			function actualizarEstadisticas() {
				document.getElementById('totalServicios').textContent = servicios.length;
				document.getElementById('totalUsuarios').textContent = usuarios.length;
				document.getElementById('totalCitas').textContent = citas.length;
				document.getElementById('ingresosMes').textContent = "$0";
			}

			function mostrarToast(mensaje, tipo = "exito") {
				const toast = document.getElementById('toast');
				const toastMensaje = document.getElementById('toast-mensaje');
				toastMensaje.textContent = mensaje;
				toast.style.backgroundColor = tipo === "error" ? "#ff4e4e" : "var(--fucsia)";
				toast.classList.add('show');
				setTimeout(() => toast.classList.remove('show'), 3000);
			}
		</script>
</body>

</html>